<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recursive Pipeline Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
        }
        .card-header {
            background-color: #f1f3f5;
            font-weight: 600;
        }
        pre {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .tab-content {
            padding: 15px;
            border: 1px solid #dee2e6;
            border-top: none;
            background-color: #fff;
        }
        .nav-tabs .nav-link {
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            font-weight: 600;
        }
        .list-group-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .list-group-item:hover {
            background-color: #f1f3f5;
        }
        .list-group-item.active {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .status-waiting {
            background-color: #6c757d;
        }
        .status-running {
            background-color: #0d6efd;
        }
        .status-completed {
            background-color: #198754;
        }
        .status-error {
            background-color: #dc3545;
        }
        .iteration-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .api-call-time {
            font-size: 0.8rem;
            color: #6c757d;
        }
        #running-time {
            font-family: monospace;
            font-weight: 600;
        }
        .dashboard-header {
            background-color: #343a40;
            color: white;
            padding: 1rem 0;
            margin-bottom: 1.5rem;
        }
        .dashboard-title {
            margin: 0;
            font-weight: 300;
        }
        .dashboard-title strong {
            font-weight: 600;
        }
        .refresh-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .refresh-btn:hover {
            color: #0d6efd;
            transform: rotate(180deg);
        }
        .connection-status {
            font-size: 0.8rem;
            margin-left: 10px;
        }
        .connection-connected {
            color: #198754;
        }
        .connection-disconnected {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="dashboard-title"><strong>Recursive Pipeline</strong> Dashboard</h1>
                <div>
                    <span id="connection-status" class="connection-status connection-disconnected">
                        <i class="bi bi-wifi-off"></i> Disconnected
                    </span>
                    <button id="refresh-btn" class="refresh-btn" title="Refresh data">
                        <i class="bi bi-arrow-clockwise fs-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">Experiment Status</div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Status:</span>
                            <span id="status-badge" class="badge status-badge status-waiting">Waiting</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Running time:</span>
                            <span id="running-time">00:00:00</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Problems:</span>
                            <span id="problem-count">0</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>API calls:</span>
                            <span id="api-call-count">0</span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Problems</div>
                    <div class="card-body p-0">
                        <ul id="problem-list" class="list-group list-group-flush">
                            <!-- Problems will be listed here -->
                            <li class="list-group-item text-center text-muted">No problems yet</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <ul class="nav nav-tabs" id="main-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="problem-tab" data-bs-toggle="tab" data-bs-target="#problem-content" type="button" role="tab" aria-controls="problem-content" aria-selected="true">Problem Details</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api-content" type="button" role="tab" aria-controls="api-content" aria-selected="false">API Calls</button>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="problem-content" role="tabpanel" aria-labelledby="problem-tab">
                        <div id="problem-details">
                            <div class="text-center py-5 text-muted">
                                <i class="bi bi-arrow-left-circle fs-1"></i>
                                <h4 class="mt-3">Select a problem from the list</h4>
                                <p>Problem details will appear here</p>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="api-content" role="tabpanel" aria-labelledby="api-tab">
                        <div id="api-calls-container">
                            <div class="text-center py-5 text-muted">
                                <i class="bi bi-cloud fs-1"></i>
                                <h4 class="mt-3">No API calls yet</h4>
                                <p>API call details will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dashboard JavaScript
        let startTime = Date.now();
        let currentProblemId = null;
        let evtSource = null;
        let isConnected = false;
        
        // Initialize the dashboard
        function initDashboard() {
            // Connect to SSE endpoint
            connectEventSource();
            
            // Initial data load
            fetchData();
            
            // Set up refresh button
            document.getElementById('refresh-btn').addEventListener('click', fetchData);
        }
        
        // Connect to the event source
        function connectEventSource() {
            if (evtSource) {
                evtSource.close();
            }
            
            // Add timestamp to prevent caching
            const timestamp = new Date().getTime();
            evtSource = new EventSource(`/api/events?_=${timestamp}`);
            
            // Track reconnection attempts
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            
            evtSource.onopen = function() {
                isConnected = true;
                updateConnectionStatus();
                reconnectAttempts = 0; // Reset reconnect attempts on successful connection
                
                // Periodically check status to keep connection alive
                if (window.statusCheckInterval) {
                    clearInterval(window.statusCheckInterval);
                }
                
                // Check status every 30 seconds instead of continuously
                window.statusCheckInterval = setInterval(() => {
                    fetch('/api/status')
                        .then(response => response.json())
                        .catch(error => console.error('Status check error:', error));
                }, 30000);
            };
            
            evtSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                updateDashboard(data);
            };
            
            evtSource.onerror = function() {
                isConnected = false;
                updateConnectionStatus();
                
                // Clear status check interval on error
                if (window.statusCheckInterval) {
                    clearInterval(window.statusCheckInterval);
                }
                
                // Close the connection
                evtSource.close();
                
                // Implement exponential backoff for reconnection
                reconnectAttempts++;
                const delay = Math.min(30000, Math.pow(2, reconnectAttempts) * 1000);
                
                console.log(`Connection error. Reconnecting in ${delay/1000} seconds (attempt ${reconnectAttempts}/${maxReconnectAttempts})...`);
                
                // Try to reconnect with increasing delay, up to max attempts
                if (reconnectAttempts <= maxReconnectAttempts) {
                    setTimeout(connectEventSource, delay);
                } else {
                    console.error('Max reconnection attempts reached. Please refresh the page.');
                }
            };
        }
        
        // Update connection status indicator
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            
            if (isConnected) {
                statusElement.className = 'connection-status connection-connected';
                statusElement.innerHTML = '<i class="bi bi-wifi"></i> Connected';
            } else {
                statusElement.className = 'connection-status connection-disconnected';
                statusElement.innerHTML = '<i class="bi bi-wifi-off"></i> Disconnected';
            }
        }
        
        // Fetch data from the API
        function fetchData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    updateDashboard(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }
        
        // Update the dashboard with new data
        function updateDashboard(data) {
            // Update status section
            updateStatus(data);
            
            // Update problem list
            updateProblemList(data);
            
            // If a problem is selected, update its details
            if (currentProblemId && data.problems[currentProblemId]) {
                showProblemDetails(currentProblemId, data);
            } else if (data.current_problem && data.problems[data.current_problem]) {
                currentProblemId = data.current_problem;
                showProblemDetails(currentProblemId, data);
            }
            
            // Update API calls tab
            updateApiCalls(data.api_calls || []);
        }
        
        // Update the status section
        function updateStatus(data) {
            const status = data.status || 'unknown';
            const statusBadge = document.getElementById('status-badge');
            
            statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            statusBadge.className = 'badge status-badge';
            
            if (status === 'waiting') {
                statusBadge.classList.add('status-waiting');
            } else if (status === 'running') {
                statusBadge.classList.add('status-running');
            } else if (status === 'completed') {
                statusBadge.classList.add('status-completed');
            } else if (status === 'error') {
                statusBadge.classList.add('status-error');
            } else {
                statusBadge.classList.add('status-waiting');
            }
            
            // Update running time
            const startTimeFromData = data.start_time ? data.start_time * 1000 : startTime;
            document.getElementById('running-time').textContent = formatTime((Date.now() - startTimeFromData) / 1000);
            
            // Update problem count
            const problemCount = Object.keys(data.problems || {}).length;
            document.getElementById('problem-count').textContent = problemCount;
            
            // Update API call count
            const apiCallCount = (data.api_calls || []).length;
            document.getElementById('api-call-count').textContent = apiCallCount;
        }
        
        // Update the problem list
        function updateProblemList(data) {
            const problemList = document.getElementById('problem-list');
            const problems = data.problems || {};
            
            // Clear the list
            problemList.innerHTML = '';
            
            if (Object.keys(problems).length === 0) {
                const li = document.createElement('li');
                li.className = 'list-group-item text-center text-muted';
                li.textContent = 'No problems yet';
                problemList.appendChild(li);
                return;
            }
            
            // Add each problem to the list
            for (const [problemId, problem] of Object.entries(problems)) {
                const li = document.createElement('li');
                li.className = `list-group-item d-flex justify-content-between align-items-center ${problemId === data.current_problem ? 'active' : ''}`;
                li.onclick = () => {
                    currentProblemId = problemId;
                    showProblemDetails(problemId, data);
                    
                    // Update active state
                    document.querySelectorAll('#problem-list .list-group-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    li.classList.add('active');
                };
                
                // Problem ID
                const idSpan = document.createElement('span');
                idSpan.textContent = problemId;
                
                // Problem status badge
                const statusBadge = document.createElement('span');
                statusBadge.className = 'badge';
                
                if (problem.status === 'completed') {
                    statusBadge.className += ' bg-success';
                    statusBadge.textContent = 'Completed';
                } else if (problem.status === 'error') {
                    statusBadge.className += ' bg-danger';
                    statusBadge.textContent = 'Error';
                } else if (problem.status === 'in_progress') {
                    statusBadge.className += ' bg-primary';
                    statusBadge.textContent = 'In Progress';
                } else {
                    statusBadge.className += ' bg-secondary';
                    statusBadge.textContent = 'Waiting';
                }
                
                li.appendChild(idSpan);
                li.appendChild(statusBadge);
                problemList.appendChild(li);
            }
        }
        
        // Show details for a specific problem
        function showProblemDetails(problemId, data) {
            const problem = data.problems[problemId];
            if (!problem) return;
            
            const detailsContainer = document.getElementById('problem-details');
            
            // Create problem header
            let html = `
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Problem ${problemId}</h5>
                            <span class="badge ${getProblemStatusClass(problem.status)}">${formatProblemStatus(problem.status)}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <p><strong>Question:</strong></p>
                        <pre>${problem.question || 'No question available'}</pre>
                    </div>
                </div>
            `;
            
            // Add iterations
            const iterations = problem.iterations || {};
            
            if (Object.keys(iterations).length === 0) {
                html += `
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-hourglass fs-1"></i>
                        <h5 class="mt-3">No iterations yet</h5>
                        <p>Iteration data will appear here as the experiment progresses</p>
                    </div>
                `;
            } else {
                // Sort iterations by number
                const sortedIterations = Object.entries(iterations)
                    .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
                
                for (const [iteration, iterData] of sortedIterations) {
                    html += `
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="iteration-header">
                                    <h5 class="mb-0">Iteration ${iteration}</h5>
                                    ${iterData.extracted_answer ? 
                                        `<span class="badge bg-info">Answer: ${iterData.extracted_answer}</span>` : 
                                        ''}
                                </div>
                            </div>
                            <div class="card-body">
                                <ul class="nav nav-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="reasoning-tab-${iteration}" data-bs-toggle="tab" data-bs-target="#reasoning-${iteration}" type="button" role="tab">Reasoning</button>
                                    </li>
                                    ${iterData.summary ? `
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="summary-tab-${iteration}" data-bs-toggle="tab" data-bs-target="#summary-${iteration}" type="button" role="tab">Summary</button>
                                    </li>
                                    ` : ''}
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="answer-tab-${iteration}" data-bs-toggle="tab" data-bs-target="#answer-${iteration}" type="button" role="tab">Answer</button>
                                    </li>
                                </ul>
                                <div class="tab-content mt-3">
                                    <div class="tab-pane fade show active" id="reasoning-${iteration}" role="tabpanel">
                                        <pre>${iterData.reasoning || 'No reasoning available'}</pre>
                                    </div>
                                    ${iterData.summary ? `
                                    <div class="tab-pane fade" id="summary-${iteration}" role="tabpanel">
                                        <pre>${iterData.summary}</pre>
                                    </div>
                                    ` : ''}
                                    <div class="tab-pane fade" id="answer-${iteration}" role="tabpanel">
                                        <p><strong>Extracted Answer:</strong> ${iterData.extracted_answer || 'None'}</p>
                                        <p><strong>Normalized Answer:</strong> ${iterData.normalized_answer || 'None'}</p>
                                        ${iterData.confidence !== null ? `<p><strong>Confidence:</strong> ${iterData.confidence}</p>` : ''}
                                        ${iterData.errors_detected ? `<p><strong>Errors Detected:</strong> ${iterData.errors_detected}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            detailsContainer.innerHTML = html;
        }
        
        // Update the API calls section
        function updateApiCalls(apiCalls) {
            const container = document.getElementById('api-calls-container');
            
            if (apiCalls.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-cloud fs-1"></i>
                        <h4 class="mt-3">No API calls yet</h4>
                        <p>API call details will appear here</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Sort API calls by timestamp (newest first)
            const sortedCalls = [...apiCalls].sort((a, b) => b.timestamp - a.timestamp);
            
            for (let i = 0; i < sortedCalls.length; i++) {
                const call = sortedCalls[i];
                const callTime = new Date(call.timestamp * 1000).toLocaleTimeString();
                
                html += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${call.endpoint || 'API Call'}</span>
                                <span class="api-call-time">${callTime}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-tabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="payload-tab-${i}" data-bs-toggle="tab" data-bs-target="#payload-${i}" type="button" role="tab">Payload</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="response-tab-${i}" data-bs-toggle="tab" data-bs-target="#response-${i}" type="button" role="tab">Response</button>
                                </li>
                            </ul>
                            <div class="tab-content mt-3">
                                <div class="tab-pane fade show active" id="payload-${i}" role="tabpanel">
                                    <pre>${JSON.stringify(call.payload || {}, null, 2)}</pre>
                                </div>
                                <div class="tab-pane fade" id="response-${i}" role="tabpanel">
                                    <pre>${JSON.stringify(call.response || {}, null, 2)}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Helper function to format time
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            return [
                hrs.toString().padStart(2, '0'),
                mins.toString().padStart(2, '0'),
                secs.toString().padStart(2, '0')
            ].join(':');
        }
        
        // Helper function to get problem status class
        function getProblemStatusClass(status) {
            if (status === 'completed') return 'bg-success';
            if (status === 'error') return 'bg-danger';
            if (status === 'in_progress') return 'bg-primary';
            return 'bg-secondary';
        }
        
        // Helper function to format problem status
        function formatProblemStatus(status) {
            if (status === 'completed') return 'Completed';
            if (status === 'error') return 'Error';
            if (status === 'in_progress') return 'In Progress';
            return 'Waiting';
        }
        
        // Initialize the dashboard when the page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
        
        // Update running time every second
        setInterval(() => {
            const runningTimeElement = document.getElementById('running-time');
            const currentTime = runningTimeElement.textContent;
            const [hours, minutes, seconds] = currentTime.split(':').map(Number);
            
            let totalSeconds = hours * 3600 + minutes * 60 + seconds + 1;
            runningTimeElement.textContent = formatTime(totalSeconds);
        }, 1000);
    </script>
</body>
</html> 