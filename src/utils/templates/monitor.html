<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiment Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .reasoning-container {
            max-height: 500px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .api-message {
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
        }
        .request {
            background-color: #e9f5ff;
        }
        .response {
            background-color: #f0fff0;
        }
        .progress {
            height: 25px;
            margin-bottom: 15px;
        }
        .progress-bar {
            font-size: 14px;
            line-height: 25px;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        .tab-content {
            padding: 20px;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        #status-panel {
            margin-bottom: 20px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .status-label {
            font-weight: bold;
        }
        .iteration-nav {
            margin-bottom: 15px;
        }
        .message-content {
            max-height: 300px;
            overflow-y: auto;
        }
        pre {
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Experiment Monitor</h1>
        
        <div id="status-panel" class="card">
            <div class="card-header">
                <h5>Experiment Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="status-item">
                            <span class="status-label">Status:</span>
                            <span id="experiment-status">Idle</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Pipeline:</span>
                            <span id="pipeline-name">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Elapsed Time:</span>
                            <span id="elapsed-time">0s</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="status-item">
                            <span class="status-label">Current Problem:</span>
                            <span id="current-problem-id">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Current Iteration:</span>
                            <span id="current-iteration">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Problems Processed:</span>
                            <span id="problems-processed">0 / 0</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>Problem Progress:</h6>
                    <div class="progress">
                        <div id="problem-progress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>Iteration Progress:</h6>
                    <div class="progress">
                        <div id="iteration-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>Current Problem</h5>
            </div>
            <div class="card-body">
                <div id="problem-question" class="mb-3">
                    <p class="text-muted">No problem being processed</p>
                </div>
                
                <ul class="nav nav-tabs" id="problemTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="reasoning-tab" data-bs-toggle="tab" data-bs-target="#reasoning" type="button" role="tab" aria-controls="reasoning" aria-selected="true">Reasoning Trace</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button" role="tab" aria-controls="api" aria-selected="false">API Messages</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="problemTabsContent">
                    <div class="tab-pane fade show active" id="reasoning" role="tabpanel" aria-labelledby="reasoning-tab">
                        <div class="iteration-nav mb-3">
                            <div class="btn-group" role="group" id="iteration-buttons">
                                <button type="button" class="btn btn-outline-primary" disabled>No iterations</button>
                            </div>
                        </div>
                        
                        <div id="reasoning-content" class="reasoning-container">
                            <p class="text-muted">No reasoning trace available</p>
                        </div>
                        
                        <div id="answer-panel" class="alert alert-info" style="display: none;">
                            <strong>Extracted Answer:</strong> <span id="extracted-answer"></span>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="api" role="tabpanel" aria-labelledby="api-tab">
                        <div class="iteration-nav mb-3">
                            <div class="btn-group" role="group" id="api-iteration-buttons">
                                <button type="button" class="btn btn-outline-primary" disabled>No iterations</button>
                            </div>
                        </div>
                        
                        <div id="api-messages-container">
                            <p class="text-muted">No API messages available</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        let currentProblemId = null;
        let currentIteration = 0;
        let maxIterations = 0;
        let currentExperimentData = null;
        
        // Format time in seconds to a readable format
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Update the status panel with current experiment state
        function updateStatusPanel(data) {
            // Store the current experiment data
            currentExperimentData = data;
            
            document.getElementById('experiment-status').textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
            document.getElementById('pipeline-name').textContent = data.pipeline || '-';
            document.getElementById('elapsed-time').textContent = formatTime(data.elapsed_time);
            
            if (data.current_problem) {
                document.getElementById('current-problem-id').textContent = data.current_problem.id;
                document.getElementById('problem-question').innerHTML = `<strong>Problem ID:</strong> ${data.current_problem.id}<br><strong>Question:</strong> ${data.current_problem.question}`;
            }
            
            document.getElementById('current-iteration').textContent = `${data.current_iteration} / ${data.iterations_total}`;
            document.getElementById('problems-processed').textContent = `${data.problems_processed} / ${data.problems_total}`;
            
            // Update progress bars
            const problemProgress = (data.problems_processed / Math.max(1, data.problems_total)) * 100;
            document.getElementById('problem-progress').style.width = `${problemProgress}%`;
            document.getElementById('problem-progress').textContent = `${Math.round(problemProgress)}%`;
            document.getElementById('problem-progress').setAttribute('aria-valuenow', problemProgress);
            
            const iterationProgress = (data.current_iteration / Math.max(1, data.iterations_total)) * 100;
            document.getElementById('iteration-progress').style.width = `${iterationProgress}%`;
            document.getElementById('iteration-progress').textContent = `${Math.round(iterationProgress)}%`;
            document.getElementById('iteration-progress').setAttribute('aria-valuenow', iterationProgress);
            
            // Update global state
            currentProblemId = data.current_problem ? data.current_problem.id : null;
            currentIteration = data.current_iteration;
            maxIterations = data.iterations_total;
        }
        
        // Update the iteration buttons based on available iterations
        function updateIterationButtons(problemId, maxIter) {
            const iterationButtons = document.getElementById('iteration-buttons');
            const apiIterationButtons = document.getElementById('api-iteration-buttons');
            
            iterationButtons.innerHTML = '';
            apiIterationButtons.innerHTML = '';
            
            if (!problemId) {
                iterationButtons.innerHTML = '<button type="button" class="btn btn-outline-primary" disabled>No iterations</button>';
                apiIterationButtons.innerHTML = '<button type="button" class="btn btn-outline-primary" disabled>No iterations</button>';
                return;
            }
            
            // Use available_iterations if present, otherwise fall back to maxIter
            const iterations = currentExperimentData && currentExperimentData.available_iterations && 
                              currentExperimentData.available_iterations.length > 0 ? 
                              currentExperimentData.available_iterations : 
                              [...Array(maxIter + 1).keys()];
            
            if (iterations.length === 0) {
                iterationButtons.innerHTML = '<button type="button" class="btn btn-outline-primary" disabled>No iterations</button>';
                apiIterationButtons.innerHTML = '<button type="button" class="btn btn-outline-primary" disabled>No iterations</button>';
                return;
            }
            
            for (const i of iterations) {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `btn btn-outline-primary ${i === currentIteration ? 'active' : ''}`;
                button.textContent = `Iteration ${i}`;
                button.onclick = () => loadReasoningTrace(problemId, i);
                iterationButtons.appendChild(button);
                
                const apiButton = document.createElement('button');
                apiButton.type = 'button';
                apiButton.className = `btn btn-outline-primary ${i === currentIteration ? 'active' : ''}`;
                apiButton.textContent = `Iteration ${i}`;
                apiButton.onclick = () => loadApiMessages(problemId, i);
                apiIterationButtons.appendChild(apiButton);
            }
        }
        
        // Load and display a reasoning trace
        function loadReasoningTrace(problemId, iteration) {
            fetch(`/api/reasoning/${problemId}/${iteration}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('reasoning-content').innerHTML = `<p class="text-muted">${data.error}</p>`;
                        document.getElementById('answer-panel').style.display = 'none';
                        return;
                    }
                    
                    document.getElementById('reasoning-content').textContent = data.reasoning;
                    
                    if (data.answer) {
                        document.getElementById('extracted-answer').textContent = data.answer;
                        document.getElementById('answer-panel').style.display = 'block';
                    } else {
                        document.getElementById('answer-panel').style.display = 'none';
                    }
                    
                    // Update active button
                    document.querySelectorAll('#iteration-buttons button').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent === `Iteration ${iteration}`) {
                            btn.classList.add('active');
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading reasoning trace:', error);
                    document.getElementById('reasoning-content').innerHTML = `<p class="text-danger">Error loading reasoning trace: ${error.message}</p>`;
                });
        }
        
        // Load and display API messages
        function loadApiMessages(problemId, iteration) {
            fetch(`/api/messages/${problemId}/${iteration}`)
                .then(response => response.json())
                .then(messages => {
                    const container = document.getElementById('api-messages-container');
                    
                    if (!messages || messages.length === 0) {
                        container.innerHTML = '<p class="text-muted">No API messages available for this iteration</p>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    
                    messages.forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `api-message ${msg.direction}`;
                        
                        const header = document.createElement('h6');
                        header.textContent = `${msg.direction.charAt(0).toUpperCase() + msg.direction.slice(1)} - ${new Date(msg.timestamp * 1000).toLocaleTimeString()}`;
                        messageDiv.appendChild(header);
                        
                        const content = document.createElement('div');
                        content.className = 'message-content';
                        
                        const pre = document.createElement('pre');
                        pre.textContent = JSON.stringify(msg.messages, null, 2);
                        content.appendChild(pre);
                        
                        messageDiv.appendChild(content);
                        container.appendChild(messageDiv);
                    });
                    
                    // Update active button
                    document.querySelectorAll('#api-iteration-buttons button').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent === `Iteration ${iteration}`) {
                            btn.classList.add('active');
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading API messages:', error);
                    document.getElementById('api-messages-container').innerHTML = `<p class="text-danger">Error loading API messages: ${error.message}</p>`;
                });
        }
        
        // Poll for status updates
        function pollStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateStatusPanel(data);
                    updateIterationButtons(currentProblemId, maxIterations);
                    
                    if (currentProblemId && data.available_iterations && data.available_iterations.length > 0) {
                        // Get the latest iteration
                        const latestIteration = Math.max(...data.available_iterations);
                        // Load the reasoning trace for the latest iteration
                        loadReasoningTrace(currentProblemId, latestIteration);
                    } else if (currentProblemId && currentIteration >= 0) {
                        loadReasoningTrace(currentProblemId, currentIteration);
                    }
                })
                .catch(error => console.error('Error polling status:', error))
                .finally(() => {
                    // Poll again after a delay
                    setTimeout(pollStatus, 5000);
                });
        }
        
        // Long-polling for real-time updates
        function startUpdateListener() {
            function fetchUpdates() {
                fetch('/api/updates')
                    .then(response => response.json())
                    .then(message => {
                        if (message.type === 'heartbeat') {
                            // No update, just a heartbeat
                            return;
                        }
                        
                        // Handle different types of updates
                        switch (message.type) {
                            case 'init':
                                // Experiment initialized
                                break;
                                
                            case 'problem_update':
                                // Problem status updated
                                break;
                                
                            case 'reasoning_trace':
                                // New reasoning trace added
                                if (currentProblemId === message.data.problem_id && 
                                    currentIteration === message.data.iteration) {
                                    loadReasoningTrace(currentProblemId, currentIteration);
                                }
                                break;
                                
                            case 'api_message':
                                // New API message added
                                break;
                                
                            case 'problem_complete':
                                // Problem completed
                                break;
                                
                            case 'experiment_complete':
                                // Experiment completed
                                break;
                        }
                        
                        // Refresh status after any update
                        pollStatus();
                    })
                    .catch(error => console.error('Error in update listener:', error))
                    .finally(() => {
                        // Continue listening
                        fetchUpdates();
                    });
            }
            
            // Start the listener
            fetchUpdates();
        }
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Initial status poll
            pollStatus();
            
            // Start update listener
            startUpdateListener();
        });
    </script>
</body>
</html> 